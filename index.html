<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Эвакуатор — Mini App</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg: #0f1115;
      --card: #171a21;
      --text: #e9edf5;
      --muted: #a7b0c0;
      --accent: #2ea6ff;
      --accent2:#1c7ed6;
      --danger:#ff5c7a;
      --border: rgba(255,255,255,.10);
      --radius: 18px;
    }
    * { box-sizing: border-box; }

    html, body{
      height: 100%;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow-x: hidden;
    }

    .screen{
      min-height: 100vh;
      width: 100%;
      display: grid;
      place-items: center;
      ## padding:
        calc(20px + env(safe-area-inset-top))
        calc(20px + env(safe-area-inset-right))
        calc(20px + env(safe-area-inset-bottom))
        calc(20px + env(safe-area-inset-left));
    }

    .wrap{ width: min(720px, 100%); margin-inline: auto; }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      padding: 28px;
      box-shadow: 0 14px 40px rgba(0,0,0,.38);
      border: 1px solid rgba(255,255,255,.08);
      text-align: center;
    }

    h1{ margin: 0 0 10px; font-size: 32px; line-height: 1.15; }
    p{ margin: 0 0 18px; color: var(--muted); font-size: 17px; line-height: 1.55; }

    .btn{
      width: 100%;
      border: 0;
      border-radius: 16px;
      padding: 16px 18px;
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      color: #fff;
      font-weight: 800;
      font-size: 17px;
      cursor: pointer;
    }
    .btn.secondary{
      background: transparent;
      border: 1px solid rgba(255,255,255,.18);
      color: var(--text);
      font-weight: 700;
    }

    .hint{ margin-top: 12px; font-size: 13px; color: rgba(255,255,255,.55); }

    .section{ display: none; }
    .section.active{ display: block; }

    .form{ margin-top: 18px; text-align: left; }
    .grid{ display: grid; grid-template-columns: 1fr; gap: 12px; }

    label{
      display: block;
      font-size: 13px;
      color: rgba(255,255,255,.72);
      margin-bottom: 6px;
    }

    input, select{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline: none;
      font-size: 16px;
    }
    input::placeholder{ color: rgba(255,255,255,.35); }

    .row{
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: end;
    }

    .smallbtn{
      height: 44px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }

    .actions{
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .error{
      display: none;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,92,122,.35);
      background: rgba(255,92,122,.12);
      color: #ffd1db;
      font-size: 14px;
      text-align: left;
    }

    .divider{
      margin: 16px 0 10px;
      height: 1px;
      background: rgba(255,255,255,.08);
    }

    .okBadge{
      width: 56px; height: 56px;
      border-radius: 16px;
      margin: 0 auto 14px;
      display: grid;
      place-items: center;
      background: rgba(34,197,94,.12);
      border: 1px solid rgba(34,197,94,.35);
      color: #a7f3d0;
      font-weight: 900;
      font-size: 28px;
      line-height: 1;
    }
    .successTitle{ margin: 0 0 8px; font-size: 28px; }
    .successText{ margin: 0 0 18px; color: var(--muted); font-size: 16px; }

    /* admin styles */
    .adminCard{
      margin-top: 14px;
      text-align: left;
      padding: 18px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .adminTitle{
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 900;
      text-align: left;
    }
    .list{
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
    }
    .item{
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 12px;
      background: rgba(0,0,0,.10);
    }
    .itemHead{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: baseline;
    }
    .pill{
      display:inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.75);
      font-size: 12px;
      margin-left: 8px;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      color: rgba(255,255,255,.80);
      margin-top: 8px;
    }
    .btnRow{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .smallbtn.danger{
      border-color: rgba(255,92,122,.35);
      background: rgba(255,92,122,.10);
    }
    .smallbtn.primary{
      border-color: rgba(46,166,255,.35);
      background: rgba(46,166,255,.10);
    }
    .mutedLine{ color: rgba(255,255,255,.60); font-size: 13px; margin-top: 8px; }
  </style>
</head>

<body>
  <div class="screen">
    <main class="wrap">
      <section class="card">

        <!-- START -->
        <div id="startSection" class="section active">
          <h1>Вызов эвакуатора</h1>
          <p>Нажмите «Заказать машину», укажите телефон, марку и адрес (или геолокацию) — заявка уйдёт диспетчеру.</p>

          <p id="driversLine" class="hint" style="margin-top:10px;">Водителей на линии: —</p>
          <div id="driversStatus" class="hint" style="margin-top:6px; opacity:.8;"></div>

          <div class="actions">
            <button id="startOrderBtn" class="btn" type="button">Заказать машину</button>
            <!-- Админ-панель: кнопка появится если открыто в Telegram и есть ?api= -->
            <button id="adminBtn" class="btn secondary" type="button" style="display:none;">Админ-панель</button>
          </div>

          <div class="hint">Mini App в Telegram</div>
        </div>

        <!-- FORM -->
        <div id="formSection" class="section">
          <h1>Заявка</h1>
          <p>Минимум данных: телефон, марка, адрес (или гео).</p>

          <div class="form">
            <div class="divider"></div>

            <div class="grid">
              <div>
                <label for="phone">Телефон</label>
                <input
                  id="phone"
                  type="tel"
                  placeholder="+7 (9__ ) ___-__-__"
                  autocomplete="tel"
                  inputmode="numeric"
                  maxlength="18"
                />
                <div class="hint" style="margin-top:8px">Формат: +7 (9XX) XXX-XX-XX</div>
              </div>

              <div>
                <label for="carBrand">Марка автомобиля</label>
                <input id="carBrand" type="text" placeholder="Например: Toyota" autocomplete="off" />
              </div>

              <div>
                <label for="address">Адрес (если удобно — текстом)</label>
                <input id="address" type="text" placeholder="Город, улица, дом / ориентир" autocomplete="street-address" />
              </div>

              <div class="row">
                <div>
                  <label for="geo">Геолокация (опционально)</label>
                  <input id="geo" type="text" placeholder="55.7558, 37.6173" inputmode="decimal" />
                </div>
                <button id="geoBtn" class="smallbtn" type="button">Определить</button>
              </div>
            </div>

            <div class="actions">
              <button id="submitBtn" class="btn" type="button">Отправить заявку</button>
              <button id="cancelBtn" class="btn secondary" type="button">Отмена</button>
            </div>

            <div id="error" class="error"></div>
            <div class="hint">Отправка через Telegram WebApp</div>
          </div>
        </div>

        <!-- SUCCESS -->
        <div id="successSection" class="section">
          <div class="okBadge">✓</div>
          <h2 class="successTitle">Заявка отправлена</h2>
          <p class="successText">Скоро свяжемся с вами.</p>

          <div class="actions">
            <button id="newOrderBtn" class="btn" type="button">Новая заявка</button>
            <button id="backToStartBtn" class="btn secondary" type="button">На главный</button>
          </div>

          <div class="hint">Можно закрыть окно и вернуться в чат</div>
        </div>

        <!-- ADMIN -->
        <div id="adminSection" class="section">
          <h1>Админ-панель</h1>
          <p id="adminTopStatus">Загрузка…</p>

          <div class="actions" style="margin-top:10px;">
            <button id="adminBackBtn" class="btn secondary" type="button">Назад</button>
          </div>

          <div class="adminCard">
            <div class="adminTitle">Водители</div>

            <div class="row">
              <div>
                <label>Сейчас на линии</label>
                <input id="adminDriversNow" type="text" disabled value="—" />
              </div>
              <button id="adminDriversRefreshBtn" class="smallbtn primary" type="button">Обновить</button>
            </div>

            <div class="btnRow">
              <button id="adminDriversPlusBtn" class="smallbtn" type="button">+1</button>
              <button id="adminDriversMinusBtn" class="smallbtn" type="button">-1</button>
            </div>

            <div class="row" style="margin-top:10px;">
              <div>
                <label for="adminDriversSet">Установить число</label>
                <input id="adminDriversSet" type="number" min="0" placeholder="Например: 7" />
              </div>
              <button id="adminDriversSetBtn" class="smallbtn" type="button">Применить</button>
            </div>

            <div id="adminDriversMsg" class="mutedLine"></div>
          </div>

          <div class="adminCard">
            <div class="adminTitle">Заявки</div>

            <div class="grid">
              <div>
                <label for="adminReqStatus">Статус</label>
                <select id="adminReqStatus">
                  <option value="">Все</option>
                  <option value="new">new</option>
                  <option value="in_work">in_work</option>
                  <option value="done">done</option>
                  <option value="cancel">cancel</option>
                </select>
              </div>

              <div>
                <label for="adminReqLimit">Лимит</label>
                <select id="adminReqLimit">
                  <option value="10">10</option>
                  <option value="20" selected>20</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
              </div>

              <div class="row">
                <div>
                  <label for="adminReqOpenId">Открыть по ID</label>
                  <input id="adminReqOpenId" type="number" min="1" placeholder="Например: 123" />
                </div>
                <button id="adminReqOpenBtn" class="smallbtn" type="button">Открыть</button>
              </div>
            </div>

            <div class="actions">
              <button id="adminReqRefreshBtn" class="btn secondary" type="button">Обновить список</button>
            </div>

            <div id="adminReqMsg" class="mutedLine"></div>
            <div id="adminReqList" class="list"></div>
          </div>

          <div class="adminCard" id="adminReqDetailsCard" style="display:none;">
            <div class="adminTitle">Заявка <span id="adminReqDetailsId" class="mono"></span></div>
            <div id="adminReqDetailsText" class="mono"></div>

            <div class="btnRow">
              <button class="smallbtn" data-setst="new" type="button">new</button>
              <button class="smallbtn" data-setst="in_work" type="button">in_work</button>
              <button class="smallbtn" data-setst="done" type="button">done</button>
              <button class="smallbtn danger" data-setst="cancel" type="button">cancel</button>
            </div>

            <div id="adminReqDetailsMsg" class="mutedLine"></div>
          </div>
        </div>

      </section>
    </main>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;

    if (tg) {
      tg.ready();
      tg.expand();
      try {
        tg.setBackgroundColor('#0f1115');
        tg.setHeaderColor('#0f1115');
      } catch (e) {}
    }

    const driversLineEl = document.getElementById('driversLine');
    const driversStatusEl = document.getElementById('driversStatus');

    function setDriversText(n) {
      driversLineEl.textContent = Number.isFinite(n)
        ## ? `Водителей на линии: ${n}`
        : 'Водителей на линии: —';
    }

    function renderDriversFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const v = params.get('drivers');
      const n = v === null ? NaN : parseInt(v, 10);
      if (Number.isFinite(n)) setDriversText(n);
    }

    function getApiUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('api'); // полный URL вида https://.../api/drivers
    }

    function getApiBase() {
      const apiUrl = getApiUrl();
      if (!apiUrl) return null;
      return apiUrl.replace(/\/api\/drivers\/?$/i, '').replace(/\/$/, '');
    }

    ## // У
